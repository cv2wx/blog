{{ $src :=  .Src }}
{{ $image := .Resources.GetMatch $src }}
{{ if $image }}
    {{ if and (ne $image.MediaType.SubType "svg") (ne $image.MediaType.SubType "gif") }}
        {{ $image = $image.Resize (print $image.Width "x" $image.Height " webp") }}
        {{ $src = $image.RelPermalink }}
    {{ end }}
{{ else }}
    {{ warnf "Unable to find image resource for src: %s" .Src }}
{{ end }}

{{- $alt := .Alt | default $src -}}
{{- $loading := resources.Get "svg/loading.svg" | minify -}}
{{- if .Linked -}}
    <a class="lightgallery" href="{{ $src | safeURL }}" title="{{ .Title | default $alt }}" data-thumbnail="{{ $src | safeURL }}"{{ with .Caption }} data-sub-html="<h2>{{ . }}</h2>{{ with $.Title }}<p>{{ . }}</p>{{ end }}"{{ end }}{{ with .Rel }} rel="{{ . }}"{{ end }}>
        <img
            class="lazyload{{ with .Class }} {{ . }}{{ end }}"
            src="{{ $loading.RelPermalink }}"
            data-src="{{ $src | partial "function/cdn.html" | safeURL }}"
            alt="{{ $alt }}"{{ with .Height }} height="{{ . }}"{{ end }}{{ with .Width }} width="{{ . }}"{{ end }} />
    </a>
{{- else -}}
    <img
        class="lazyload{{ with .Class }} {{ . }}{{ end }}"
        src="{{ $loading.RelPermalink }}"
        data-src="{{ $src | partial "function/cdn.html" | safeURL }}"
        alt="{{ $alt }}"
        title="{{ .Title | default $alt }}"{{ with .Height }} height="{{ . }}"{{ end }}{{ with .Width }} width="{{ . }}"{{ end }} />
{{- end -}}
